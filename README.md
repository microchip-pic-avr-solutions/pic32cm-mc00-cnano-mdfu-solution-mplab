![Microchip logo](https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png)

# Microchip Device Firmware Update (MDFU) Bootloader Solution for PIC32CM-MC00 Curiosity Nano Evaluation Kit

## Project Overview

This repository provides an optimized MDFU bootloader client for the PIC32CM-MC00 Curiosity Nano. It demonstrates firmware update workflows using the MDFU Protocol over UART, I<sup>2</sup>C, and SPI interfaces. It also highlights support for Multi-Image (MI) updates and Anti-Rollback (ARB) features. All code is stand-alone with required drivers generated through MPLAB® Harmony 3, but Harmony is not required for operation.

- [Microchip 32-bit MCUs](https://www.microchip.com/design-centers/32-bit)
- [Microchip 32-bit MPUs](https://www.microchip.com/design-centers/32-bit-mpus)
- [Microchip MPLAB® X IDE](https://www.microchip.com/mplab/mplab-x-ide)
- [Microchip MPLAB® Harmony v3](https://www.microchip.com/mplab/mplab-harmony)

**Included Projects**

- MDFU Bootloader over UART, I<sup>2</sup>C, SPI
- Example test applications (LED blink, console output) for each interface

## Folder Structure and Contents

| Folder             | Description                                                            |
| ------------------ | ---------------------------------------------------------------------- |
| Bootloader_UART    | MDFU client with UART communication interface                          |
| Application_UART   | Example app for UART bootloader                                        |
| Bootloader_I2C     | MDFU client with I<sup>2</sup>C communication interface                |
| Application_I2C    | Example app for I<sup>2</sup>C bootloader                              |
| Bootloader_SPI     | MDFU client with SPI communication interface                           |
| Application_SPI    | Example app for SPI bootloader                                         |
| Bootloader_MI_ARB  | MDFU client with multi-image and anti-rollback features                |
| Application_MI_ARB | Example app for bootloader with multi-image and anti-rollback features |
| docs               | API documentation, Doxygen configs                                     |

---

## Hardware and Software Requirements

- [PIC32CM MC00 Curiosity Nano Evaluation Kit](https://www.microchip.com/en-us/development-tool/ev10n93a)
- [MCP2221A](https://www.microchip.com/en-us/product/mcp2221a)
- [MCP2210](https://www.microchip.com/en-us/development-tool/ADM00419)
- [MPLAB® X IDE](https://www.microchip.com/en-us/tools-resources/develop/mplab-x-ide)
- [XC32 C/C++ Compiler, v4.60 or newer](https://www.microchip.com/en-us/tools-resources/develop/mplab-xc-compilers/xc32)
- [pymdfu, v2.5.1.9 or newer](https://pypi.org/project/pymdfu/)
- [pyfwimagebuilder, v1.3.0.16 or newer](https://pypi.org/project/pyfwimagebuilder/)

---

## Bootloader and Application Features

**Bootloader Features (UART/I<sup>2</sup>C/SPI):**

- MDFU Protocol file transfer (UART, I<sup>2</sup>C and SPI)
- CRC-32 through Device Service Unit (DSU) peripheral
- Software re-entry through RAM region
- LED status indicator

> **Note**: This content does not require MPLAB Harmony 3 and uses custom start-up code and linker script that is not generated by Harmony. Ensure to not overwrite this logic if the user intends on generating new code using Harmony.

**Application Features (UART/I<sup>2</sup>C/SPI):**

- Console output and LED blink using timer interrupt
- Bootloader mode re-entry by switch press
- Default application image for direct flashing (`PIC32CM_DefaultTest.img`)

> **Note:** A default application image has been generated and included in the repo for testing purposes. If the user does not wish to build the image using the steps below, the user can use the default test image for testing the client update logic.

**Bootloader Features (Multi-Image and Anti-Rollback):**

- MDFU Protocol file transfer (UART)
- CRC-32 through Device Service Unit (DSU) peripheral
- Software re-entry through RAM region
- LED status indicator
- Multiple images (execution and staging)
- Anti-Rollback

**Application Features (Multi-Image and Anti-Rollback):**

- Console output and LED blink using timer interrupt
- Bootloader mode re-entry by switch press
- Two application images (`PIC32CM_TestApp_Binary_v1.img` and `PIC32CM_TestApp_Binary_v2.img`)

> **Note:** `PIC32CM_TestApp_Binary_v1.img` will blink the LED at a faster rate, whereas `PIC32CM_TestApp_Binary_v2.img` will blink the LED at slower rate.

---

## Getting Started and Operation

### General Steps

1. Open MPLAB X IDE.
2. Open the desired bootloader project (`/Bootloader_UART...`).
   - Open the bootloader project by navigating to `File>Open Project...` and select the bootloader project from the file system navigator, `<repository path>/Bootloader_UART/<bootloader_project_name>.X`
3. Set the bootloader project as main, clean/build, and program device.
   - In the **Projects** tab, right-click on the Bootloader project folder and select _Set as Main Project_
   - In the **Projects** tab, right-click the Bootloader project folder and select _Clean and Build_
   - Again, right-click the Bootloader project folder and select _Make and Program Device_
   - The bootloader will indicate that it is running and ready to receive an image by illuminating the on-board LED
4. Open the example application project (`/Application_UART...`), clean/build.
   - Open the application project by navigating to `File>Open Project...` and select the application project from the file system navigator, `<repository path>/Application_UART/<application_project_name>.X`
   - Navigate to the Project Properties, select the **Building** tab, and enable the _Execute this line after build_ option
   - In the **Projects** tab, right-click the Application project folder and select _Clean and Build_
5. Edit and run the update script (`run.bat`/`run.sh`) for user platform, setting the correct port/interface below.
   - Open the `<repository path>/Application_UART/<application_project_name>.X> > run.bat` on Windows or the `run.sh` if the user is on Mac or Linux
   - In MPLAB X IDE, this file can be found under **Important Files** tab in the project

> **Note:** This process will execute the pymdfu update command through a MPLAB X console and print the output within the IDE. If the user does not have access to Python environment from within MPLAB X, the user can copy the command from inside the script into any terminal with access to the pymdfu Python tool.

The following are steps to demonstrate the Multi-Image and Anti-Rollback features.

### Multi-Image and Anti-Rollback Steps

1. Complete the steps 1-3 in [General Steps](#general-steps).
   - Open the Multi-Image and Anti--Rollback bootloader from the file system navigator: `<repository path>/Bootloader_MI_ARB/<bootloader_project_name>.X`
2. Edit and run the update script (`run.bat`/`run.sh`) with the version one of the application (`PIC32CM_TestApp_Binary_v1.img`) for user platform, setting the correct port/interface below.
   - Open the `<repository path>/Application_MI_ARB/<application_project_name.X> > run.bat` on Windows or the `run.sh` if the user is on Mac or Linux
   - In MPLAB X IDE, this file can be found under **Important Files** tab in the project
     > **Note:** At this point, the version one of the application is running on the device, indicated by the on-board LED blinking at a rate of 850 ms.
3. Press and hold the on-board switch to re-enter the bootloader.
4. To perform a firmware update with the version two of the application, update the command in the `run.bat`/`run.sh` script and run it.
   ```bash
   pymdfu update -v debug --tool serial --port <Port Name> --baudrate 115200 --image PIC32CM_TestApp_Binary_v2.img
   ```
   > **Note:** It can be observed that the application with the version two is blinking the LED at a slower rate than before. This demonstrates the bootloader's capability to store multiple images in multiple image partitions.
5. Repeat the step 3 to transfer control back to the bootloader.
6. To demonstrate the anti-rollback feature, perform an update with the version one of the application by reverting the command in the `run.bat`/`run.sh` script and running it.
   ```bash
   pymdfu update -v debug --tool serial --port <Port Name> --baudrate 115200 --image PIC32CM_TestApp_Binary_v1.img
   ```
   > **Note:** It can be observed from the MPLAB X console that the firmware update is unsuccessful due to attempting to update to an older version of the application.
7. Power cycle the board by unplugging the device and plugging it back in to transfer the control back to the lastest version of the application (version two).

#### Operation by Interface

<details>
<summary><strong>UART</strong></summary>

- Bootloader project path: `<repository>/Bootloader_UART/PIC32CM_MDFU_UART.X`
- Application project path: `<repository>/Application_UART/PIC32CM_TestApp_UART.X`
- Run script example:
  ```bash
  pymdfu update -v debug --tool serial --port <Port Name> --baudrate 115200 --image PIC32CM_TestApp.img
  ```

> **Tip:** The user can use the MPLAB Data Visualizer to find the port name of the Curiosity Nano.

</details>

<details>
<summary><strong>I<sup>2</sup>C</strong></summary>

- Bootloader project path: `<repository>/Bootloader_I2C/PIC32CM_MDFU_I2C.X`
- Application project path: `<repository>/Application_I2C/PIC32CM_TestApp_I2C.X`
- Run script example:
  ```bash
  pymdfu update --tool mcp2221a --interface i2c --image PIC32CM_TestApp_I2C.img --clk-speed 100000 --address 32
  ```
  </details>

<details>
<summary><strong>SPI</strong></summary>

- Bootloader project path: `<repository>/Bootloader_SPI/PIC32CM_MDFU_SPI.X`
- Application project path: `<repository>/Application_SPI/PIC32CM_TestApp_SPI.X`
- Run script example:
  ```bash
  pymdfu update -v debug --tool mcp2210 --image PIC32CM_TestApp.img --clk-speed 500000 --chip-select 1
  ```
  </details>

<details>
<summary><strong>Multi-Image and Anti-Rollback</strong></summary>

- Bootloader project path: `<repository>/Bootloader_MI_ARB/PIC32CM_MDFU_MI_ARB.X`
- Application project path: `<repository>/Application_MI_ARB/PIC32CM_TestApp_MI_ARB.X`
- Run script example:
  ```bash
  pymdfu update -v debug --tool serial --port <Port Name> --baudrate 115200 --image PIC32CM_TestApp_Binary_v1.img
  ```
  </details>

## Debugging Tips

- Useful pymdfu commands

```
$ > pymdfu -V
pymdfu version 2.5.1.9
MDFU protocol version 1.2.0

$ > pymdfu update --tool serial --port COM3 --baudrate 115200 --image PIC32CM_TestApp.img
Upgrade finished successfully
```

- Adding the CLI flag `-v debug` onto the end of the pymdfu command will enable debug logging for the Python tool, allowing the user to see the data transfers with more details

- The user can use the MPLAB Data Visualizer to see the program print statements by opening the MPLAB Data Visualizer and selecting the **Display as text in terminal** button on the Curiosity Nano's port name

Data Visualizer Settings:

- Baudrate: 115200
- Char Length: 8
- Parity Bit: None
- Stop Bits: 1
- DTR: Enabled
- RTS: Enabled

**General Tips:**

- Use the MPLAB Data Visualizer to confirm port and monitor serial output
- On-board LED indicates bootloader status; LED blinks on application entry
- Press the nano’s switch to re-enter Bootloader mode and re-initiate update

---

## References

For additional information, refer to the following resources:

- [Microchip Device Firmware Update (MDFU) Protocol Specification 1.0.0](https://onlinedocs.microchip.com/oxy/GUID-58904FDA-338A-488F-A88D-766D29B27E37-en-US-1/index.html)
- [PIC32CM MC00 Family Data Sheet](https://ww1.microchip.com/downloads/aemDocuments/documents/MCU32/ProductDocuments/DataSheets/PIC32CM-MC00-Family-Data-Sheet-DS60001638.pdf)
- [Firmware Update Image Specification for 32-bit Devices](./docs/FirmwareUpdateFileFormat.md)
- [PIC32CM MC00 Curiosity Nano MDFU Client Solution API Documentation](./docs/PIC32CM%20MC00%20Curiosity%20Nano%20MDFU%20Client%20Solution%20API%20Documentation%201.0.0=en-US.pdf)

---

[Back to Top](#microchip-device-firmware-update-mdfu-bootloader-solution-for-pic32cm-mc00-curiosity-nano-evaluation-kit)
